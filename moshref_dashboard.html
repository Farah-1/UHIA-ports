<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UHIA - نظام الرقابة الشامل المطور</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --admin-bg: #f8fafc; --primary: #1e3a8a; --white: #ffffff; --danger: #ef4444; --success: #10b981; --warning: #f59e0b; --info: #3b82f6; }
        body { font-family: 'Cairo', sans-serif; background-color: var(--admin-bg); margin: 0; display: flex; }
        
        /* Sidebar */
        .sidebar { width: 260px; background: var(--primary); height: 100vh; color: white; position: fixed; right: 0; top: 0; padding: 20px; display: flex; flex-direction: column; z-index: 1001; box-shadow: -5px 0 15px rgba(0,0,0,0.1); }
        .sidebar h2 { text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px; font-size: 1.1rem; margin-top: 0; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 14px; cursor: pointer; transition: 0.3s; border-radius: 12px; margin-bottom: 8px; font-size: 0.95rem; opacity: 0.8; }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.15); opacity: 1; font-weight: 600; }
        
        .main-content { margin-right: 260px; width: calc(100% - 260px); padding: 30px; box-sizing: border-box; }

        /* Shift Switch */
        .shift-container { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; background: #e2e8f0; padding: 5px; border-radius: 50px; width: fit-content; margin-left: auto; margin-right: auto; }
        .btn-shift { padding: 10px 35px; border: none; background: transparent; color: #64748b; border-radius: 40px; cursor: pointer; font-weight: bold; transition: 0.3s; font-family: 'Cairo'; }
        .btn-shift.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(30, 58, 138, 0.3); }

        /* Dashboard Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); text-align: center; border-top: 5px solid var(--primary); transition: 0.3s; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px rgba(0,0,0,0.05); }
        .stat-card h4 { margin: 0; font-size: 0.85rem; color: #64748b; }
        .stat-card p { margin: 12px 0 0; font-size: 1.8rem; font-weight: 800; color: var(--primary); }

        /* Containers & Tables */
        .data-container { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); margin-bottom: 30px; }
        .table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        th { text-align: right; padding: 15px; color: #64748b; font-size: 0.85rem; border-bottom: 2px solid #f1f5f9; }
        td { padding: 12px 15px; background: #fdfdfd; font-size: 0.8rem; border-top: 1px solid #f1f5f9; border-bottom: 1px solid #f1f5f9; }
        td:first-child { border-right: 1px solid #f1f5f9; border-radius: 0 10px 10px 0; }
        td:last-child { border-left: 1px solid #f1f5f9; border-radius: 10px 0 0 10px; }

        /* Tags */
        .tag { padding: 5px 12px; border-radius: 8px; font-size: 0.75rem; font-weight: 700; display: inline-block; }
        .tag-present { background: #dcfce7; color: #15803d; border: 1px solid #86efac; }
        .tag-absent { background: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; }
        .tag-guest { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
        .tag-out { background: #f1f5f9; color: #475569; }

        /* Enhanced Date Picker */
        .date-picker-bar { display: flex; gap: 15px; align-items: center; margin-bottom: 25px; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .date-input-group { display: flex; align-items: center; gap: 8px; background: #f1f5f9; padding: 8px 15px; border-radius: 10px; border: 1px solid #e2e8f0; }
        .date-input-group input { border: none; background: transparent; font-family: 'Cairo'; font-weight: 600; color: var(--primary); outline: none; }
        
        .btn-action { background: var(--primary); color: white; border: none; padding: 10px 25px; border-radius: 10px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: 0.3s; }
        .btn-action:hover { opacity: 0.9; transform: scale(1.02); }

        .section-view { display: none; animation: fadeIn 0.4s ease; }
        .section-view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .facility-block { margin-bottom: 35px; }
        .facility-title { background: #eff6ff; color: var(--primary); padding: 10px 20px; border-radius: 12px; display: flex; align-items: center; gap: 10px; margin-bottom: 15px; font-weight: 700; border-right: 4px solid var(--primary); }

        /* Modal for Editing */
        #editModal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 5% auto; padding: 25px; border-radius: 15px; width: 450px; max-width: 90%; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 5px; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; font-family: 'Cairo'; box-sizing: border-box; }
    </style>
</head>
<body>

<div class="sidebar">
    <h2 id="moshref-name">جاري التحميل...</h2>
    <div id="btn-overview" class="nav-item active" onclick="showSec('overview')"><i class="material-icons">dashboard</i> لوحة التحكم اليومية</div>
    <div id="btn-timeseries" class="nav-item" onclick="showSec('timeseries')"><i class="material-icons">timeline</i> تحليل السلاسل الزمنية</div>
    <div id="btn-attendance" class="nav-item" onclick="showSec('attendance')"><i class="material-icons">history</i> سجل المنشآت التفصيلي</div>
    <div id="btn-staff" class="nav-item" onclick="showSec('staff')"><i class="material-icons">people</i> طاقم العمل</div>
    <div class="nav-item" style="margin-top: auto; color: #fda4af;" onclick="logout()"><i class="material-icons">logout</i> خروج</div>
</div>

<div class="main-content">
    <div id="global-shift-container" class="shift-container">
        <button id="shift-morning" class="btn-shift active" onclick="changeShift('صباحي')">الوردية الصباحية</button>
        <button id="shift-night" class="btn-shift" onclick="changeShift('مسائي')">الوردية المسائية</button>
    </div>

    <div id="sec-overview" class="section-view active">
        <div class="stats-grid" id="stats-summary"></div>
        <div class="data-container">
            <h3>مخطط التغطية الفعلية للوردية</h3>
            <div style="height: 280px;"><canvas id="attendanceChart"></canvas></div>
        </div>
        <div class="data-container">
            <div class="table-header">
                <h3>ملخص حالة المنشآت (اليوم)</h3>
            </div>
            <table id="fac-summary-table">
                <thead><tr><th>المنشأة</th><th>القوة المطلوبة</th><th>الحضور الفعلي</th><th>العجز/الزيادة</th></tr></thead>
                <tbody id="fac-table-body"></tbody>
            </table>
        </div>
    </div>

    <div id="sec-timeseries" class="section-view">
        <div class="date-picker-bar">
            <div class="date-input-group">
                <i class="material-icons" style="font-size: 1.2rem; color: #64748b;">calendar_today</i>
                <span>من:</span> <input type="date" id="date-from">
            </div>
            <div class="date-input-group">
                <i class="material-icons" style="font-size: 1.2rem; color: #64748b;">event</i>
                <span>إلى:</span> <input type="date" id="date-to">
            </div>
            <button class="btn-action" onclick="generateTimeSeries()"><i class="material-icons">analytics</i> عرض التحليل</button>
            <button class="btn-action" style="background:var(--success); margin-right: auto;" onclick="exportTimeSeriesExcel()"><i class="material-icons">download</i> تصدير Excel</button>
        </div>
        <div id="ts-summary-container" class="data-container">
            <h3>الملخص العام للفترة المختارة (شامل الورديتين)</h3>
            <div id="ts-summary-table-area"></div>
        </div>
        <div id="ts-details-container"></div>
    </div>

    <div id="sec-attendance" class="section-view">
        <div class="data-container">
            <div class="table-header">
                <h3>تقرير الحضور والغياب التفصيلي</h3>
                <span id="current-shift-label" class="tag tag-present" style="font-size: 0.9rem; padding: 8px 20px;"></span>
            </div>
            <div id="facility-detail-area"></div>
        </div>
    </div>

    <div id="sec-staff" class="section-view">
        <div class="data-container">
            <div class="table-header"><h3>قاعدة بيانات الموظفين المسجلين</h3></div>
            <table id="staff-list-table">
                <thead><tr><th>الاسم</th><th>المنشأة</th><th>الوردية</th><th>الهاتف</th><th>إجراءات</th></tr></thead>
                <tbody id="staff-list-body"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="editModal">
    <div class="modal-content">
        <h3>تعديل بيانات الموظف</h3>
        <input type="hidden" id="edit-id">
        <div class="form-group"><label>الاسم الكامل</label><input type="text" id="edit-name"></div>
        <div class="form-group">
            <label>المحافظة</label>
            <select id="edit-gov" onchange="filterFacsByGov(this.value)"></select>
        </div>
        <div class="form-group">
            <label>المنشأة</label>
            <select id="edit-fac"></select>
        </div>
        <div class="form-group">
            <label>الوردية</label>
            <select id="edit-shift"><option value="صباحي">صباحي</option><option value="مسائي">مسائي</option></select>
        </div>
        <div class="form-group"><label>الهاتف</label><input type="text" id="edit-phone"></div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn-action" onclick="saveUserData()" style="flex:1;">حفظ</button>
            <button class="btn-action" onclick="closeModal()" style="background:#64748b; flex:1;">إلغاء</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDgiNw5Dt6EkiokRjznzGkfZvVuDN0APPk",
        authDomain: "uhia-attendancesystem.firebaseapp.com",
        projectId: "uhia-attendancesystem",
        storageBucket: "uhia-attendancesystem.firebasestorage.app",
        messagingSenderId: "104444545133",
        appId: "1:104444545133:web:f40607b93fb90a8f511764"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const userData = JSON.parse(sessionStorage.getItem('userData'));
    const myFacs = userData?.assignedFacilities || [];
    let currentShift = 'صباحي';
    let globalUsers = [];
    let globalLogs = [];
    let facilityRefData = []; 
    let myChart = null;

    window.onload = async () => {
        if (!userData) { window.location.href = "index.html"; return; }
        document.getElementById('moshref-name').innerText = userData.fullName;
        
        const today = new Date().toISOString().split('T')[0];
        const lastWeek = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        document.getElementById('date-from').value = lastWeek;
        document.getElementById('date-to').value = today;

        const facSnap = await getDocs(collection(db, "FacilitiesReference"));
        facilityRefData = facSnap.docs.map(d => d.data());

        const govSel = document.getElementById('edit-gov');
        const uniqueGovs = [...new Set(facilityRefData.map(f => f.governorate))].sort();
        uniqueGovs.forEach(g => govSel.add(new Option(g, g)));

        await fetchData();
    };

    async function fetchData() {
        const uSnap = await getDocs(collection(db, "UsersRegistry"));
        globalUsers = uSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        const lSnap = await getDocs(collection(db, "AttendanceLogs"));
        globalLogs = lSnap.docs.map(d => d.data());
        processData();
    }

    window.changeShift = (shift) => {
        currentShift = shift;
        document.getElementById('shift-morning').classList.toggle('active', shift === 'صباحي');
        document.getElementById('shift-night').classList.toggle('active', shift === 'مسائي');
        document.getElementById('current-shift-label').innerText = "عرض بيانات الوردية الـ" + shift;
        processData();
    };

    function processData() {
        const todayStr = new Date().toDateString();
        const todayLogs = globalLogs.filter(l => l.loginTime?.toDate().toDateString() === todayStr);
        const shiftWorkforce = globalUsers.filter(u => myFacs.includes(u.facility) && u.shift === currentShift && u.role !== 'moshref');
        const shiftStaffIDs = shiftWorkforce.map(u => u.nationalID);
        const shiftLogs = todayLogs.filter(l => myFacs.includes(l.facility) && l.shift === currentShift);

        const activeUsers = shiftLogs.filter(l => shiftStaffIDs.includes(l.nationalID) && !l.logoutTime);
        const logoutUsers = shiftLogs.filter(l => shiftStaffIDs.includes(l.nationalID) && l.logoutTime);
        const activeGuests = shiftLogs.filter(l => !shiftStaffIDs.includes(l.nationalID) && !l.logoutTime);
        const logoutGuests = shiftLogs.filter(l => !shiftStaffIDs.includes(l.nationalID) && l.logoutTime);

        renderCards(shiftWorkforce.length, activeUsers.length, logoutUsers.length, activeGuests.length, logoutGuests.length);
        renderOverviewTable(shiftWorkforce, shiftLogs);
        renderFacilityDetails(shiftWorkforce, shiftLogs);
        renderStaffTab();
        updateChart(shiftWorkforce, shiftLogs);
    }

    function renderCards(total, uActive, uOut, gActive, gOut) {
        document.getElementById('stats-summary').innerHTML = `
            <div class="stat-card"><h4>القوة المطلوبة</h4><p>${total}</p></div>
            <div class="stat-card" style="border-top-color: var(--success)"><h4>حضور (موظفين)</h4><p>${uActive}</p></div>
            <div class="stat-card" style="border-top-color: var(--warning)"><h4>حضور (ضيوف)</h4><p>${gActive}</p></div>
            <div class="stat-card" style="border-top-color: #64748b"><h4>إجمالي الانصراف</h4><p>${uOut + gOut}</p></div>
        `;
    }

    function renderOverviewTable(shiftWorkforce, shiftLogs) {
        document.getElementById('fac-table-body').innerHTML = myFacs.map(f => {
            const req = shiftWorkforce.filter(u => u.facility === f).length;
            const pres = shiftLogs.filter(l => l.facility === f && !l.logoutTime).length;
            const diff = pres - req;
            return `<tr><td>${f}</td><td>${req}</td><td>${pres}</td><td><span class="tag ${diff<0?'tag-absent':'tag-present'}">${diff>0?'+':''}${diff}</span></td></tr>`;
        }).join('');
    }

    function renderFacilityDetails(shiftWorkforce, shiftLogs) {
        let html = '';
        myFacs.forEach(fac => {
            const facStaff = shiftWorkforce.filter(u => u.facility === fac);
            const facLogs = shiftLogs.filter(l => l.facility === fac);
            const guestLogs = facLogs.filter(l => !shiftWorkforce.find(u => u.nationalID === l.nationalID));

            html += `<div class="facility-block">
                <div class="facility-title"><i class="material-icons">business</i> ${fac}</div>
                <table>
                    <thead><tr><th>الاسم</th><th>الرقم القومي</th><th>رقم الهاتف</th><th>المنشأة الأصلية</th><th>الحالة</th><th>حضور</th><th>انصراف</th></tr></thead>
                    <tbody>`;
            
            facStaff.forEach(u => {
                const log = facLogs.find(l => l.nationalID === u.nationalID);
                let statusTag = !log ? '<span class="tag tag-absent">غائب</span>' : (log.logoutTime ? '<span class="tag tag-out">انصرف</span>' : '<span class="tag tag-present">حاضر الآن</span>');
                html += `<tr><td>${u.fullName}</td><td>${u.nationalID}</td><td>${u.phoneNumber || '-'}</td><td>${u.facility}</td>
                    <td>${statusTag}</td><td>${log?.loginTime?.toDate().toLocaleTimeString('ar-EG') || '-'}</td><td>${log?.logoutTime?.toDate().toLocaleTimeString('ar-EG') || '-'}</td></tr>`;
            });

            guestLogs.forEach(g => {
                const guestData = globalUsers.find(u => u.nationalID === g.nationalID);
                const orig = guestData?.facility || 'منتدب خارجي';
                const phone = guestData?.phoneNumber || '-';
                html += `<tr><td>${g.fullName}</td><td>${g.nationalID}</td><td>${phone}</td><td><span class="tag tag-guest">${orig}</span></td>
                    <td><span class="tag tag-guest">${g.logoutTime ? 'انصرف' : 'حاضر (ضيف)'}</span></td><td>${g.loginTime.toDate().toLocaleTimeString('ar-EG')}</td><td>${g.logoutTime?.toDate().toLocaleTimeString('ar-EG') || '-'}</td></tr>`;
            });
            html += `</tbody></table></div>`;
        });
        document.getElementById('facility-detail-area').innerHTML = html;
    }

    window.generateTimeSeries = () => {
        const fromDate = new Date(document.getElementById('date-from').value);
        const toDate = new Date(document.getElementById('date-to').value);
        toDate.setHours(23, 59, 59);

        let summaryHtml = `<table><thead><tr><th>المنشأة</th><th>إجمالي المطلوب</th><th>حضور (صباحي)</th><th>حضور (مسائي)</th><th>إجمالي ضيوف</th><th>الصافي</th></tr></thead><tbody>`;
        let detailsHtml = '';

        myFacs.forEach(fac => {
            let facRows = '';
            let facTotals = { req:0, morn:0, night:0, guest:0, diff:0 };
            for (let d = new Date(fromDate); d <= toDate; d.setDate(d.getDate() + 1)) {
                const dayStr = d.toDateString();
                const dayLogs = globalLogs.filter(l => l.facility === fac && l.loginTime?.toDate().toDateString() === dayStr);
                const dayStaff = globalUsers.filter(u => u.facility === fac && u.role !== 'moshref');
                const mReq = dayStaff.filter(u => u.shift === 'صباحي').length;
                const nReq = dayStaff.filter(u => u.shift === 'مسائي').length;
                const mPres = dayLogs.filter(l => l.shift === 'صباحي' && dayStaff.some(u => u.nationalID === l.nationalID)).length;
                const nPres = dayLogs.filter(l => l.shift === 'مسائي' && dayStaff.some(u => u.nationalID === u.nationalID)).length;
                const guests = dayLogs.filter(l => !dayStaff.some(u => u.nationalID === l.nationalID)).length;
                const dailyDiff = (mPres + nPres + guests) - (mReq + nReq);
                facRows += `<tr><td>${d.toLocaleDateString('ar-EG')}</td><td>${mReq}</td><td>${mPres}</td><td>${nReq}</td><td>${nPres}</td><td>${guests}</td><td style="font-weight:700; color:${dailyDiff<0?'var(--danger)':'var(--success)'}">${dailyDiff}</td></tr>`;
                facTotals.req += (mReq + nReq); facTotals.morn += mPres; facTotals.night += nPres; facTotals.guest += guests; facTotals.diff += dailyDiff;
            }
            summaryHtml += `<tr><td>${fac}</td><td>${facTotals.req}</td><td>${facTotals.morn}</td><td>${facTotals.night}</td><td>${facTotals.guest}</td><td>${facTotals.diff}</td></tr>`;
            detailsHtml += `<div class="data-container"><h3>تحليل منشأة: ${fac}</h3><table id="ts-table-${fac.replace(/\s/g,'_')}"><thead><tr><th>التاريخ</th><th>مطلوب(ص)</th><th>حاضر(ص)</th><th>مطلوب(م)</th><th>حاضر(م)</th><th>ضيوف</th><th>الصافي</th></tr></thead><tbody>${facRows}</tbody></table></div>`;
        });
        document.getElementById('ts-summary-table-area').innerHTML = summaryHtml + `</tbody></table>`;
        document.getElementById('ts-details-container').innerHTML = detailsHtml;
    };

    window.exportTimeSeriesExcel = () => {
        const wb = XLSX.utils.book_new();
        const summaryTable = document.querySelector('#ts-summary-table-area table');
        if(!summaryTable) return alert("يرجى عرض البيانات أولاً");
        XLSX.utils.book_append_sheet(wb, XLSX.utils.table_to_sheet(summaryTable), "الملخص العام");
        myFacs.forEach(fac => {
            const table = document.getElementById(`ts-table-${fac.replace(/\s/g,'_')}`);
            if(table) XLSX.utils.book_append_sheet(wb, XLSX.utils.table_to_sheet(table), fac.substring(0,30));
        });
        XLSX.writeFile(wb, `UHIA_Full_Report.xlsx`);
    };

    window.renderStaffTab = () => {
        const myAllStaff = globalUsers.filter(u => myFacs.includes(u.facility));
        document.getElementById('staff-list-body').innerHTML = myAllStaff.map(u => `
            <tr>
                <td>${u.fullName}</td>
                <td>${u.facility}</td>
                <td>${u.shift}</td>
                <td>${u.phoneNumber || '-'}</td>
                <td>
                    <button class="material-icons" style="color:var(--info); background:none; border:none; cursor:pointer;" onclick="openEditModal('${u.id}')">edit</button>
                    <button class="material-icons" style="color:var(--danger); background:none; border:none; cursor:pointer;" onclick="deleteUser('${u.id}')">delete</button>
                </td>
            </tr>`).join('');
    };

    window.openEditModal = (id) => {
        const u = globalUsers.find(x => x.id === id);
        document.getElementById('edit-id').value = id;
        document.getElementById('edit-name').value = u.fullName;
        document.getElementById('edit-gov').value = u.government || "";
        document.getElementById('edit-shift').value = u.shift;
        document.getElementById('edit-phone').value = u.phoneNumber || "";
        filterFacsByGov(u.government, u.facility);
        document.getElementById('editModal').style.display = 'block';
    };

    window.filterFacsByGov = (govName, selectedFac = "") => {
        const facDropdown = document.getElementById('edit-fac');
        facDropdown.innerHTML = "";
        const filtered = facilityRefData.filter(f => f.governorate === govName);
        filtered.forEach(f => {
            const opt = new Option(f.facilityName, f.facilityName);
            if(f.facilityName === selectedFac) opt.selected = true;
            facDropdown.add(opt);
        });
    };

    window.saveUserData = async () => {
        const id = document.getElementById('edit-id').value;
        const updateObj = {
            fullName: document.getElementById('edit-name').value,
            government: document.getElementById('edit-gov').value,
            facility: document.getElementById('edit-fac').value,
            shift: document.getElementById('edit-shift').value,
            phoneNumber: document.getElementById('edit-phone').value
        };
        await updateDoc(doc(db, "UsersRegistry", id), updateObj);
        alert("تم الحفظ بنجاح");
        closeModal();
        fetchData();
    };

    window.deleteUser = async (id) => {
        if(confirm("هل أنت متأكد من حذف هذا الموظف؟")) {
            await deleteDoc(doc(db, "UsersRegistry", id));
            fetchData();
        }
    };

    window.closeModal = () => document.getElementById('editModal').style.display = 'none';

    function updateChart(shiftWorkforce, shiftLogs) {
        const ctx = document.getElementById('attendanceChart').getContext('2d');
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: myFacs,
                datasets: [
                    { label: 'المطلوب', data: myFacs.map(f => shiftWorkforce.filter(u => u.facility === f).length), backgroundColor: '#e2e8f0' },
                    { label: 'الحضور الفعلي', data: myFacs.map(f => shiftLogs.filter(l => l.facility === f && !l.logoutTime).length), backgroundColor: '#1e3a8a' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
        });
    }

    window.showSec = (id) => {
        document.querySelectorAll('.section-view').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(`sec-${id}`).classList.add('active');
        document.getElementById(`btn-${id}`).classList.add('active');
        
        // التعديل هنا: إخفاء التبديل في صفحة التحليل وصفحة طاقم العمل
        if (id === 'timeseries' || id === 'staff') {
            document.getElementById('global-shift-container').style.display = 'none';
        } else {
            document.getElementById('global-shift-container').style.display = 'flex';
        }
    };

    window.logout = () => { sessionStorage.clear(); window.location.href = "index.html"; };
</script>
</body>
</html>