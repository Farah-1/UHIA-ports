<!DOCTYPE html>
<html dir="rtl">
<head>
    
  <title>منظومة المنافذ الصحية - UHIA</title>
  <meta property="og:title" content="منظومة المنافذ الصحية - UHIA">
  <meta property="og:description" content="تسجيل الحضور والانصراف - الهيئة العامة للتأمين الصحي الشامل">
  <meta property="og:image" content="https://th.bing.com/th/id/R.59d5ce0fdd736c17f99baf306040b306?rik=i9YpNmQIDemEVQ&riu=http%3a%2f%2fwww.alistech-eg.com%2fimg%2fclients-logo%2fuhia.png&ehk=GgAou6EsHRouGC44Sgwpf1HMlX%2bv%2f1ExEbsPIRGBEAE%3d&risl=&pid=ImgRaw&r=0">
  <meta property="og:type" content="website">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root { 
            --primary: #1a5276; 
            --secondary: #28a745; 
            --error: #e74c3c;
            --bg: #f4f7f9; 
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: var(--bg); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
            padding: 15px; 
        }

        .auth-card { 
            background: white; 
            width: 100%; 
            max-width: 450px; 
            padding: 2.5rem; 
            border-radius: 25px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.1); 
            text-align: center;
            box-sizing: border-box;
        }

        .logo { width: 150px; margin-bottom: 1.5rem; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); }
        
        h2 { color: var(--primary); margin-bottom: 0.5rem; font-size: 1.6rem; }
        p { color: #666; margin-bottom: 1.5rem; font-size: 0.9rem; }

        input, select { 
            width: 100%; 
            padding: 14px; 
            margin: 10px 0; 
            border: 1px solid #ddd; 
            border-radius: 12px; 
            box-sizing: border-box; 
            font-size: 16px; 
            outline: none;
            transition: 0.3s;
        }

        input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 8px rgba(26, 82, 118, 0.1); }

        button { 
            width: 100%; 
            padding: 14px; 
            margin-top: 20px; 
            border: none; 
            border-radius: 12px; 
            font-weight: bold; 
            cursor: pointer; 
            transition: 0.3s; 
            font-size: 17px; 
        }

        .btn-login { background: var(--primary); color: white; }
        .btn-login:hover { background: #154360; transform: translateY(-2px); }

        .btn-reg { background: var(--secondary); color: white; }
        .btn-reg:hover { background: #218838; transform: translateY(-2px); }

        .toggle-link { 
            margin-top: 1.5rem; 
            color: var(--primary); 
            cursor: pointer; 
            text-decoration: none; 
            font-size: 0.95rem; 
            display: block; 
            font-weight: 500;
        }

        .hidden { display: none !important; }

        #status { 
            margin-top: 15px; 
            padding: 12px; 
            border-radius: 10px; 
            font-size: 14px; 
            display: none; 
            font-weight: 500;
        }

        /* Responsive Adjustments */
        @media (max-width: 480px) {
            .auth-card { padding: 1.5rem; }
            h2 { font-size: 1.4rem; }
        }
    </style>
</head>
<body>

<div class="auth-card">
    <img src="https://th.bing.com/th/id/R.59d5ce0fdd736c17f99baf306040b306?rik=i9YpNmQIDemEVQ&riu=http%3a%2f%2fwww.alistech-eg.com%2fimg%2fclients-logo%2fuhia.png" class="logo" alt="UHIA Logo">
    
    <div id="login-box">
        <h2>تسجيل الدخول</h2>
        <p>منظومة المنافذ الصحية - UHIA</p>
        <input type="text" id="login-id" placeholder="الرقم القومي (14 رقم)" maxlength="14">
        <input type="password" id="login-pass" placeholder="كلمة المرور">
        <button class="btn-login" onclick="handleLogin()">دخول</button>
        <span class="toggle-link" onclick="toggleAuth()">ليس لديك حساب؟ سجل الآن</span>
    </div>

  <div id="reg-box" class="hidden">
    <h2>إنشاء حساب جديد</h2>
    <input type="text" id="reg-name" placeholder="الاسم الرباعي">
    <input type="text" id="reg-id" placeholder="الرقم القومي (14 رقم)" maxlength="14">
    <input type="tel" id="reg-phone" placeholder="رقم الهاتف (11 رقم)" maxlength="11">
    
    <select id="reg-gov" onchange="loadFacilitiesForGov(this.value)">
        <option value="">اختر المحافظة</option>
        <option>بورسعيد</option><option>السويس</option><option>الإسماعيلية</option>
        </select>

    <select id="reg-facility-select" onchange="checkOtherFacility(this.value)">
        <option value="">اختر المنشأة</option>
    </select>
    
    <input type="text" id="reg-facility-other" class="hidden" placeholder="اكتب اسم المنشأة الجديدة هنا">

    <select id="reg-shift">
        <option value="">اختر الوردية</option>
        <option value="صباحي">صباحي</option>
        <option value="مسائي">مسائي</option>
    </select>

    <input type="password" id="reg-pass" placeholder="تعيين كلمة مرور">
    <button class="btn-reg" onclick="handleRegister()">إنشاء الحساب</button>
</div>

<script type="module">
    // ... إعدادات Firebase المعتادة ...
    import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // تحميل المنشآت عند اختيار المحافظة
    window.loadFacilitiesForGov = async (gov) => {
        const select = document.getElementById('reg-facility-select');
        select.innerHTML = '<option value="">جاري التحميل...</option>';
        
        const q = query(collection(db, "FacilitiesReference"), where("governorate", "==", gov));
        const querySnapshot = await getDocs(q);
        
        select.innerHTML = '<option value="">اختر المنشأة</option>';
        querySnapshot.forEach((doc) => {
            select.innerHTML += `<option value="${doc.data().facilityName}">${doc.data().facilityName}</option>`;
        });
        select.innerHTML += '<option value="other">-- منشأة أخرى غير موجودة --</option>';
    };

    window.checkOtherFacility = (val) => {
        const otherInput = document.getElementById('reg-facility-other');
        val === 'other' ? otherInput.classList.remove('hidden') : otherInput.classList.add('hidden');
    };

    window.handleRegister = async () => {
        // ... جمع البيانات المعتاد ...
        let finalFacility = document.getElementById('reg-facility-select').value;
        const isNewFacility = finalFacility === 'other';
        if(isNewFacility) finalFacility = document.getElementById('reg-facility-other').value;

        // 1. تحديد الموقع للمنشأة الجديدة (اختياري في التسجيل أو نعتمد على أول حضور)
        navigator.geolocation.getCurrentPosition(async (pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;

            try {
                // 2. تسجيل المستخدم
                const userRef = doc(db, "UsersRegistry", id);
                await setDoc(userRef, {
                    fullName: name, nationalID: id, phoneNumber: phone,
                    governorate: gov, facility: finalFacility, shift: shift,
                    password: pass, createdAt: new Date()
                });

                // 3. تحديث جدول المنشآت (FacilitiesReference)
                const facID = `${gov}-${finalFacility}`.replace(/\s+/g, '_');
                const facRef = doc(db, "FacilitiesReference", facID);
                const facSnap = await getDoc(facRef);

                if (facSnap.exists()) {
                    // زيادة الموظفين (إضافة الاسم للقائمة)
                    await updateDoc(facRef, {
                        staffList: arrayUnion(`${name}|${phone}`)
                    });
                } else {
                    // إنشاء منشأة جديدة
                    await setDoc(facRef, {
                        facilityName: finalFacility,
                        governorate: gov,
                        lat: lat, lng: lng,
                        staffList: [`${name}|${phone}`]
                    });
                    alert("تم إضافة منشأتك الجديدة للنظام بنجاح!");
                }
                
                showStatus("✅ تم التسجيل بنجاح", "green");
                setTimeout(toggleAuth, 2000);
            } catch (e) { showStatus("❌ خطأ في التسجيل", "red"); }
        });
    };
</script>

</body>
</html>