<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UHIA - Admin Dashboard Pro</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --admin-bg: #f1f5f9;
            --primary: #1e3a8a;
            --white: #ffffff;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --accent: #6366f1;
            --glass: rgba(255, 255, 255, 0.8);
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--admin-bg);
            margin: 0;
            display: flex;
            flex-direction: column;
        }

        /* Sidebar Desktop */
        .sidebar {
            width: 260px;
            background: var(--primary);
            height: 100vh;
            color: white;
            position: fixed;
            right: 0;
            top: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            z-index: 1100;
            transition: 0.3s;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
        }

        .sidebar h2 { text-align: center; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 20px; margin-top: 0; font-weight: 700; letter-spacing: 1px; }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            cursor: pointer;
            transition: 0.3s;
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.15); border-right: 4px solid var(--white); transform: translateX(-5px); }

        /* Mobile Header */
        .mobile-header {
            display: none;
            background: var(--primary);
            color: white;
            padding: 15px;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1002;
        }

        /* Main Content */
        .main-content {
            margin-right: 260px;
            width: calc(100% - 260px);
            padding: 25px;
            box-sizing: border-box;
            transition: 0.3s;
        }

        /* Header Bar */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            background: var(--white);
            padding: 15px 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }

        .dashboard-filters {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-top: 4px solid var(--accent);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: 0.3s;
        }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }

        .stat-card h3 { margin: 0; color: #64748b; font-size: 0.95rem; }
        .stat-card p { margin: 10px 0 0; font-size: 1.8rem; font-weight: bold; color: var(--primary); }
        .stat-card .icon-bg { position: absolute; left: -10px; bottom: -10px; font-size: 4rem; opacity: 0.05; }

        /* Map Styles */
        #facilities-map {
            height: 500px;
            width: 100%;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            z-index: 1;
        }

        /* Small Map Marker Adjustment */
        .leaflet-marker-icon {
            width: 20px !important;
            height: 30px !important;
            margin-left: -10px !important;
            margin-top: -30px !important;
        }

        .map-search-results {
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-top: 5px;
            display: none;
            position: absolute;
            width: 100%;
            z-index: 1000;
        }
        .map-search-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .map-search-item:hover { background: #f0f7ff; }

        /* Table & Tools */
        .data-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 25px;
        }

        .table-header-tools {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .search-group {
            display: flex;
            gap: 10px;
            flex-grow: 1;
            position: relative;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th { background: #f8fafc; text-align: right; padding: 12px; border-bottom: 2px solid #e2e8f0; color: #475569; }
        td { padding: 12px; border-bottom: 1px solid #e2e8f0; }
        tr:hover { background-color: #f1f5f9; }

        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
        }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-info { background: #e0f2fe; color: #0369a1; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }

        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            z-index: 2000;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(3px);
            z-index: 1500;
        }

        .btn-add { background: var(--success); color: white; border: none; padding: 12px 20px; border-radius: 10px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .btn-primary { background: var(--primary); color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .btn-primary:hover { opacity: 0.9; transform: scale(1.02); }

        input, select { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 10px; box-sizing: border-box; font-family: 'Cairo'; outline: none; transition: 0.2s; }
        input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); }

        .digital-clock { font-size: 1.1rem; font-weight: 700; color: var(--primary); }

        @media (max-width: 992px) {
            .sidebar { transform: translateX(100%); width: 260px; }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-right: 0; width: 100%; padding: 15px; }
            .mobile-header { display: flex; }
        }
    </style>
</head>
<body>

<div class="mobile-header">
    <span style="font-weight: bold; font-size: 1.2rem;">UHIA Dashboard</span>
    <i class="material-icons" onclick="toggleSidebar()" style="cursor: pointer;">menu</i>
</div>

<div id="sidebar" class="sidebar">
    <h2>UHIA ADMIN</h2>
    <div class="nav-item active" onclick="navTo('attendance', event)"><i class="material-icons">analytics</i> سجلات الحضور اليومية</div>
    <div class="nav-item" onclick="navTo('users', event)"><i class="material-icons">badge</i> إدارة العاملين بالمنافذ</div>
    <div class="nav-item" onclick="navTo('facilities', event)"><i class="material-icons">location_city</i> إدارة المنافذ الصحيه</div>
    <div class="nav-item" onclick="navTo('map-view', event)"><i class="material-icons">map</i> الخريطة التفاعلية</div>
    
    <div class="nav-item" style="margin-top: auto; color: #fda4af;" onclick="logoutAdmin()">
        <i class="material-icons">power_settings_new</i> تسجيل الخروج
    </div>
</div>

<div class="main-content">
    
    <div class="top-bar">
        <div>
            <h1 style="margin:0; font-size: 1.5rem; color: var(--primary);">لوحة التحكم الرئيسية</h1>
            <p style="margin:0; color: #64748b; font-size: 0.85rem;" id="live-date">تحميل التاريخ...</p>
        </div>
        <div class="digital-clock" id="digital-clock">00:00:00</div>
    </div>

    <div id="first-page-header">
        <div class="dashboard-filters">
            <div style="flex:1; min-width: 150px;">
                <label style="font-size: 0.8rem; font-weight: bold; display: block; margin-bottom: 5px;"><i class="material-icons" style="font-size:12px">calendar_today</i> من تاريخ:</label>
                <input type="date" id="dash-date-start" onchange="refreshData()">
            </div>
            <div style="flex:1; min-width: 150px;">
                <label style="font-size: 0.8rem; font-weight: bold; display: block; margin-bottom: 5px;"><i class="material-icons" style="font-size:12px">event</i> إلى تاريخ:</label>
                <input type="date" id="dash-date-end" onchange="refreshData()">
            </div>
            <div style="flex:1; min-width: 150px;">
                <label style="font-size: 0.8rem; font-weight: bold; display: block; margin-bottom: 5px;"><i class="material-icons" style="font-size:12px">schedule</i> تصفية حسب الوردية:</label>
                <select id="dash-shift-filter" onchange="refreshData()">
                    <option value="all">كل الورديات (24 ساعة)</option>
                    <option value="morning">الوردية الصباحية</option>
                    <option value="night">الوردية المسائية</option>
                </select>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>إجمالي الحضور للفترة</h3>
                <p id="stat-today">0</p>
            </div>
            <div class="stat-card" style="border-bottom: 4px solid var(--success);">
                <h3>نشط حاليا للفترة</h3>
                <p id="stat-active" style="color: var(--success);">0</p>
            </div>
            <div class="stat-card" style="border-bottom: 4px solid var(--accent);">
                <h3> منشآت تم فيها تسجيل حضور</h3>
                <p id="stat-used-fac" style="color: var(--accent);">0</p>
            </div>
            <div class="stat-card" style="border-bottom: 4px solid var(--warning);">
                <h3>إجمالي المنشآت بالكامل</h3>
                <p id="stat-total-fac" style="color: var(--warning);">0</p>
            </div>
            <div class="stat-card">
                <h3>إجمالي المسجلين</h3>
                <p id="stat-users">0</p>
            </div>
        </div>
    </div>

    <div id="sec-map-view" class="data-container" style="display:none;">
        <div class="table-header-tools">
            <h2>الخريطة التفاعلية للمنافذ الصحيه</h2>
            <div class="search-group" style="max-width: 600px; display: flex; gap: 10px;">
                <select id="map-gov-filter" onchange="renderMapMarkers()" style="max-width: 200px;">
                    <option value="">كل المحافظات</option>
                    <option>القاهرة</option><option>الجيزة</option><option>الإسكندرية</option>
                    <option>بورسعيد</option><option>السويس</option><option>الإسماعيلية</option>
                    <option>البحيرة</option><option>دمياط</option><option>الشرقية</option>
                    <option>الغربية</option><option>المنوفية</option><option>الدقهلية</option>
                    <option>الفيوم</option><option>المنيا</option><option>أسيوط</option>
                    <option>سوهاج</option><option>قنا</option><option>أسوان</option>
                    <option>كفر الشيخ</option><option>شمال سيناء</option><option>جنوب سيناء</option>
                    <option>البحر الاحمر</option><option>الوادي الجديد</option><option>الاقصر</option>
                    <option>مطروح</option><option>بني سويف</option><option>القليوبيه</option>
                </select>
                <div style="position: relative; flex: 1;">
                    <input type="text" id="map-search" placeholder="ابحث عن منشأة على الخريطة..." onkeyup="searchOnMap()">
                    <div id="map-search-results" class="map-search-results"></div>
                </div>
            </div>
        </div>
        <div style="display: flex; gap: 20px; margin-bottom: 10px; font-size: 0.85rem; font-weight: bold;">
            <div style="display:flex; align-items:center; gap:5px;"><span style="width:12px; height:12px; background:green; border-radius:50%; display:inline-block;"></span> متاح (يوجد حضور حالياً)</div>
            <div style="display:flex; align-items:center; gap:5px;"><span style="width:12px; height:12px; background:red; border-radius:50%; display:inline-block;"></span> غير متاح (لا يوجد حضور)</div>
        </div>
        <div id="facilities-map"></div>
    </div>

    <div id="sec-attendance" class="data-container">
        <div class="table-header-tools">
            <div style="display:flex; align-items:center; gap:10px">
                <i class="material-icons" style="color:var(--primary)">history_edu</i>
                <h2 style="margin:0">سجلات الحضور وتفاصيل الورديات</h2>
            </div>
            <button class="btn-add" style="background: var(--primary);" onclick="exportTableToExcel('attendance-table-to-export', 'Attendance_Report')">
                <i class="material-icons">download</i> استخراج تقرير Excel
            </button>
        </div>
        <div class="search-group" style="margin-bottom: 15px;">
            <i class="material-icons" style="position: absolute; margin-right: 10px; margin-top: 12px; color: #94a3b8;">search</i>
            <input type="text" id="search-attendance" class="search-bar" style="padding-right: 40px;" placeholder="ابحث بالاسم، الرقم القومي، أو المنشأة..." onkeyup="filterTable('attendance-table', this.value)">
        </div>
        <div style="overflow-x:auto">
            <table id="attendance-table-to-export">
                <thead>
                    <tr>
                        <th>الموظف</th>
                        <th>المنشأة</th>
                        <th>الوردية المحتسبة</th>
                        <th>وقت الدخول</th>
                        <th>وقت الخروج</th>
                        <th>مدة العمل</th>
                        <th>إجراء</th>
                    </tr>
                </thead>
                <tbody id="attendance-table"></tbody>
            </table>
        </div>
    </div>

    <div id="sec-users" class="data-container" style="display:none;">
        <div class="table-header-tools">
            <h2>إدارة شئون الموظفين</h2>
            <button class="btn-add" style="background: var(--primary);" onclick="exportTableToExcel('users-table-to-export', 'Users_List')">
                <i class="material-icons">download</i> استخراج Excel
            </button>
        </div>
        <div class="search-group" style="margin-bottom: 20px;">
            <input type="text" id="search-users-main" placeholder="ابحث بالاسم أو الرقم القومي  ..." onkeyup="filterUsers()">
            <select id="filter-user-gov" onchange="filterUsers()" style="max-width: 150px;">
                <option value="">كل المحافظات</option>
                  <option>القاهرة</option><option>الجيزة</option><option>الإسكندرية</option>
                <option>بورسعيد</option><option>السويس</option><option>الإسماعيلية</option>
                <option>البحيرة</option><option>دمياط</option><option>الشرقية</option>
                <option>الغربية</option><option>المنوفية</option><option>الدقهلية</option>
                <option>الفيوم</option><option>المنيا</option><option>أسيوط</option>
                <option>سوهاج</option><option>قنا</option><option>أسوان</option>
                <option>كفر الشيخ</option><option>شمال سيناء</option><option>جنوب سيناء</option>
                <option>البحر الاحمر</option><option>الوادي الجديد</option><option>الاقصر</option>
                <option>مطروح</option><option>بني سويف</option><option>القليوبيه</option>
            </select>
            <input type="text" id="search-user-fac" placeholder="ابحث بجهة العمل..." onkeyup="filterUsers()" style="max-width: 200px;">
        </div>
        <div style="overflow-x:auto">
            <table id="users-table-to-export">
                <thead>
                    <tr>
                        <th>الاسم الكامل</th>
                        <th>الرقم القومي / ID</th>
                        <th>كلمة المرور</th>
                        <th>المحافظة</th> <th>المنشأة</th>  <th>الهاتف</th>
                        <th>إجراء</th>
                    </tr>
                </thead>
                <tbody id="users-table"></tbody>
            </table>
        </div>
    </div>

    <div id="sec-facilities" class="data-container" style="display:none;">
        <div class="table-header-tools">
            <h2>إدارة وتوزيع المنشآت</h2>
            <div style="display:flex; gap:10px;">
                <button class="btn-add" style="background: #64748b;" onclick="exportTableToExcel('facilities-table-to-export', 'Facilities_Directory')">
                    <i class="material-icons">download</i> Excel
                </button>
                <button class="btn-add" onclick="openModal('fac-modal')"><i class="material-icons">add</i> إضافة منشأة</button>
            </div>
        </div>
        
        <div class="search-group" style="margin-bottom: 20px;">
            <input type="text" id="search-fac-name" placeholder="ابحث باسم المنشأة..." onkeyup="filterFacilities()">
            <select id="filter-fac-gov" onchange="filterFacilities()" style="max-width: 200px;">
                <option value="">جميع المحافظات (تجميع)</option>
                <option>بورسعيد</option><option>السويس</option><option>الإسماعيلية</option><option>أسوان</option><option>جنوب سيناء</option><option>القاهرة</option>
            </select>
        </div>

        <div style="overflow-x:auto">
            <table id="facilities-table-to-export">
                <thead>
                    <tr>
                        <th>اسم المنشأة</th>
                        <th>المحافظة</th>
                        <th>الموظفون المسجلون</th>
                        <th>الحضور بالفترة</th>
                        <th>الإحداثيات</th>
                        <th>إجراء</th>
                    </tr>
                </thead>
                <tbody id="facilities-table"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="overlay" class="overlay" onclick="closeAll()"></div>

<div id="fac-modal" class="modal">
    <h3><i class="material-icons">domain</i> إضافة منشأة جديدة</h3>
    <input type="text" id="m-fac-name" placeholder="اسم المنشأة">
    <select id="m-fac-gov">
        <option value="">اختر المحافظة</option>
           <option>القاهرة</option><option>الجيزة</option><option>الإسكندرية</option>
                <option>بورسعيد</option><option>السويس</option><option>الإسماعيلية</option>
                <option>البحيرة</option><option>دمياط</option><option>الشرقية</option>
                <option>الغربية</option><option>المنوفية</option><option>الدقهلية</option>
                <option>الفيوم</option><option>المنيا</option><option>أسيوط</option>
                <option>سوهاج</option><option>قنا</option><option>أسوان</option>
                <option>كفر الشيخ</option><option>شمال سيناء</option><option>جنوب سيناء</option>
                <option>البحر الاحمر</option><option>الوادي الجديد</option><option>الاقصر</option>
                <option>مطروح</option><option>بني سويف</option><option>القليوبيه</option>
    </select>
    <div style="display: flex; gap: 10px;">
        <input type="number" id="m-fac-lat" step="any" placeholder="خط العرض Lat">
        <input type="number" id="m-fac-lng" step="any" placeholder="خط الطول Lng">
    </div>
    <button class="btn-add" style="width:100%; margin-top:15px;" onclick="saveFacility()">حفظ البيانات</button>
</div>

<div id="edit-user-modal" class="modal">
    <h3><i class="material-icons">edit</i> تعديل بيانات موظف</h3>
    <input type="hidden" id="edit-u-id">
    <label>الاسم الكامل</label>
    <input type="text" id="edit-u-name">
    <label>الرقم القومي</label>
    <input type="text" id="edit-u-ni">
    <label>كلمة المرور</label>
    <input type="text" id="edit-u-pass">
    <label>رقم الهاتف</label>
    <input type="text" id="edit-u-phone">
    <div style="display:flex; gap:10px; margin-top:20px;">
        <button class="btn-add" style="flex:1" onclick="updateUser()">تحديث</button>
        <button class="btn-add" style="flex:1; background:var(--danger)" onclick="closeModal()">إلغاء</button>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, deleteDoc, setDoc, updateDoc, query, orderBy, where, Timestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDgiNw5Dt6EkiokRjznzGkfZvVuDN0APPk",
        authDomain: "uhia-attendancesystem.firebaseapp.com",
        projectId: "uhia-attendancesystem",
        storageBucket: "uhia-attendancesystem.firebasestorage.app",
        messagingSenderId: "104444545133",
        appId: "1:104444545133:web:f40607b93fb90a8f511764"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let map;
    let markersLayer = L.layerGroup();
    let allFacilities = [];
    let allAttendance = [];
    let allUsers = [];
    let currentShiftAttendance = []; // To track status for map colors

    // Custom Icon Colors Logic
    function createCustomIcon(color) {
        return new L.Icon({
            iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [20, 30], // Smaller size requested
            iconAnchor: [10, 30],
            popupAnchor: [1, -34],
            shadowSize: [30, 30]
        });
    }

    // --- Clock & Date Logic ---
    function updateClock() {
        const now = new Date();
        const timeStr = now.toLocaleTimeString('en-GB');
        const dateStr = now.toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        
        const clockEl = document.getElementById('digital-clock');
        const dateEl = document.getElementById('live-date');
        
        if(clockEl) clockEl.innerText = timeStr;
        if(dateEl) dateEl.innerText = dateStr;
    }
    setInterval(updateClock, 1000);

    // --- UI Helpers ---
    window.toggleSidebar = () => {
        const sb = document.getElementById('sidebar');
        sb.classList.toggle('active');
        document.getElementById('overlay').style.display = sb.classList.contains('active') ? 'block' : 'none';
    };

    window.closeAll = () => {
        document.getElementById('sidebar').classList.remove('active');
        window.closeModal();
    };

    window.navTo = (section, event) => {
        const header = document.getElementById('first-page-header');
        header.style.display = (section === 'attendance') ? 'block' : 'none';

        document.querySelectorAll('.data-container').forEach(s => s.style.display = 'none');
        const target = document.getElementById(`sec-${section}`);
        if(target) target.style.display = 'block';
        
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');

        if(section === 'map-view') {
            setTimeout(() => { 
                map.invalidateSize();
                renderMapMarkers();
            }, 200);
        }
        if(window.innerWidth <= 992) window.closeAll();
    };

    // --- Core Logic ---

    window.onload = async () => {
        let user = JSON.parse(sessionStorage.getItem('userData'));
        if (!user || user.role !== 'admin') {
            window.location.href = "index.html";
            return;
        }

        const today = new Date().toISOString().split('T')[0];
        document.getElementById('dash-date-start').value = today;
        document.getElementById('dash-date-end').value = today;
        
        initMap();
        updateClock();
        await refreshData();
    };

    window.refreshData = async function() {
        const startDateStr = document.getElementById('dash-date-start').value;
        const endDateStr = document.getElementById('dash-date-end').value;
        const selectedShift = document.getElementById('dash-shift-filter').value;

        if (!startDateStr || !endDateStr) return;

        const boundaryStart = new Date(startDateStr);
        boundaryStart.setHours(0, 0, 0, 0);
        
        const boundaryEnd = new Date(endDateStr);
        boundaryEnd.setHours(23, 59, 59, 999);

        try {
            const [attSnap, facSnap, userSnap] = await Promise.all([
                getDocs(collection(db, "AttendanceLogs")),
                getDocs(collection(db, "FacilitiesReference")),
                getDocs(collection(db, "UsersRegistry"))
            ]);

            allAttendance = attSnap.docs.map(d => ({id: d.id, ...d.data()}));
            allFacilities = facSnap.docs.map(d => ({id: d.id, ...d.data()}));
            allUsers = userSnap.docs.map(d => ({id: d.id, ...d.data()}));

            const filteredAtt = allAttendance.filter(log => {
                if(!log.loginTime) return false;
                const loginDate = log.loginTime instanceof Timestamp ? log.loginTime.toDate() : new Date(log.loginTime);
                const isInPeriod = (loginDate >= boundaryStart && loginDate <= boundaryEnd);
                if (!isInPeriod) return false;

                const hour = loginDate.getHours();
                const calcShift = (hour >= 8 && hour < 16) ? 'morning' : 'night';
                log.calculatedShift = calcShift; 

                if (selectedShift !== 'all' && selectedShift !== calcShift) return false;
                return true;
            });

            currentShiftAttendance = filteredAtt; // Global reference for map color checking

            const totalAttendance = filteredAtt.length;
            const activeNow = filteredAtt.filter(log => !log.logoutTime).length;
            const distinctFacilities = [...new Set(filteredAtt.map(log => log.facility))].length;
            const totalSystemUsers = allUsers.filter(u => u.role !== 'admin').length;
            const totalFacInDb = allFacilities.length;

            document.getElementById('stat-today').innerText = totalAttendance;
            document.getElementById('stat-active').innerText = activeNow;
            document.getElementById('stat-used-fac').innerText = distinctFacilities;
            document.getElementById('stat-total-fac').innerText = totalFacInDb;
            document.getElementById('stat-users').innerText = totalSystemUsers;

            renderAttendanceTable(filteredAtt);
            renderUsersTable();
            renderFacilitiesTable(filteredAtt);
            renderMapMarkers();

        } catch (err) {
            console.error("Data Fetch Error:", err);
            alert("حدث خطأ أثناء تحديث البيانات.");
        }
    }

    function renderAttendanceTable(data) {
        const table = document.getElementById('attendance-table');
        table.innerHTML = "";
        data.sort((a,b) => {
            const dateA = a.loginTime instanceof Timestamp ? a.loginTime.toDate() : new Date(a.loginTime);
            const dateB = b.loginTime instanceof Timestamp ? b.loginTime.toDate() : new Date(b.loginTime);
            return dateB - dateA;
        });

        data.forEach(log => {
            const loginDate = log.loginTime instanceof Timestamp ? log.loginTime.toDate() : new Date(log.loginTime);
            const logoutDate = log.logoutTime ? (log.logoutTime instanceof Timestamp ? log.logoutTime.toDate() : new Date(log.logoutTime)) : null;
            const shiftLabel = log.calculatedShift === 'morning' ? 
                '<span class="badge badge-info">صباحية</span>' : 
                '<span class="badge badge-warning">مسائية </span>';

            table.innerHTML += `<tr>
                <td><b>${log.fullName || 'غير معروف'}</b><br><small>${log.nationalID || '-'}</small></td>
                <td>${log.facility || '-'}</td>
                <td>${shiftLabel}</td>
                <td>${loginDate.toLocaleString('ar-EG')}</td>
                <td>${logoutDate ? logoutDate.toLocaleTimeString('ar-EG') : '<span class="badge badge-success">متواجد حالياً</span>'}</td>
                <td>${log.workDuration || '-'}</td>
                <td><button class="btn-delete" style="padding: 5px 10px; background: var(--danger); color:white; border:none; border-radius:5px; cursor:pointer;" onclick="deleteRecord('AttendanceLogs', '${log.id}')">حذف</button></td>
            </tr>`;
        });
    }

    function renderUsersTable() {
        const table = document.getElementById('users-table');
        table.innerHTML = "";
        
        allUsers.forEach(u => {
            if(u.role === 'admin') return;
            table.innerHTML += `<tr class="user-row" data-name="${u.fullName || ''}" data-id="${u.nationalID || u.id}" data-gov="${u.governorate || ''}" data-fac="${u.facility || ''}">
                <td><b>${u.fullName || '-'}</b></td>
                <td>${u.nationalID || u.id}</td>
                <td><code>${u.password || '-'}</code></td>
                <td>${u.governorate || '-'}</td> <td>${u.facility || '-'}</td>    <td>${u.phoneNumber || '-'}</td>
                <td>
                    <button class="btn-edit" style="padding: 5px 10px; background: var(--accent); color:white; border:none; border-radius:5px; cursor:pointer;" onclick="openEditUserModal('${u.id}', ${JSON.stringify(u).replace(/"/g, '&quot;')})">تعديل</button>
                    <button class="btn-delete" style="padding: 5px 10px; background: var(--danger); color:white; border:none; border-radius:5px; cursor:pointer;" onclick="deleteRecord('UsersRegistry', '${u.id}')">حذف</button>
                </td>
            </tr>`;
        });
    }

    function renderFacilitiesTable(filteredData) {
        const table = document.getElementById('facilities-table');
        table.innerHTML = "";

        allFacilities.forEach(f => {
            const assignedCount = allUsers.filter(u => u.facility === f.facilityName).length;
            const periodCount = filteredData.filter(log => log.facility === f.facilityName).length;
            const lat = f.lat || 0;
            const lng = f.lng || 0;

            table.innerHTML += `<tr class="fac-row" data-name="${f.facilityName}" data-gov="${f.governorate}">
                <td><b>${f.facilityName}</b></td>
                <td>${f.governorate}</td>
                <td style="text-align:center"><span class="badge" style="background:#f1f5f9">${assignedCount} موظف</span></td>
                <td style="text-align:center"><span class="badge badge-success">${periodCount} سجل</span></td>
                <td><small>${lat.toFixed(3)}, ${lng.toFixed(3)}</small></td>
                <td><button class="btn-delete" style="padding: 5px 10px; background: var(--danger); color:white; border:none; border-radius:5px; cursor:pointer;" onclick="deleteRecord('FacilitiesReference', '${f.id}')">حذف</button></td>
            </tr>`;
        });
    }

    // --- Search & Filters ---

    window.filterUsers = () => {
        const nameQuery = document.getElementById('search-users-main').value.toLowerCase();
        const govQuery = document.getElementById('filter-user-gov').value;
        const facQuery = document.getElementById('search-user-fac').value.toLowerCase();

        document.querySelectorAll('.user-row').forEach(row => {
            const matchName = (row.dataset.name?.toLowerCase() || "").includes(nameQuery) || (row.dataset.id || "").includes(nameQuery);
            const matchGov = !govQuery || row.dataset.gov === govQuery;
            const matchFac = (row.dataset.fac?.toLowerCase() || "").includes(facQuery);
            row.style.display = (matchName && matchGov && matchFac) ? '' : 'none';
        });
    };

    window.filterFacilities = () => {
        const nameQuery = document.getElementById('search-fac-name').value.toLowerCase();
        const govQuery = document.getElementById('filter-fac-gov').value;

        document.querySelectorAll('.fac-row').forEach(row => {
            const matchName = row.dataset.name.toLowerCase().includes(nameQuery);
            const matchGov = !govQuery || row.dataset.gov === govQuery;
            row.style.display = (matchName && matchGov) ? '' : 'none';
        });
    };

    window.filterTable = (tableId, query) => {
        const q = query.toLowerCase();
        document.querySelectorAll(`#${tableId} tr`).forEach(row => {
            row.style.display = row.innerText.toLowerCase().includes(q) ? '' : 'none';
        });
    };

    // --- Map Logic (IMPROVED SEARCH & COLORS) ---

    function initMap() {
        if(map) return;
        map = L.map('facilities-map').setView([26.8206, 30.8025], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap'
        }).addTo(map);
        markersLayer.addTo(map);
    }

    window.renderMapMarkers = function() {
        markersLayer.clearLayers();
        const govFilter = document.getElementById('map-gov-filter').value;

        allFacilities.forEach(f => {
            // Apply Governorate Filter
            if (govFilter && f.governorate !== govFilter) return;

            if(f.lat && f.lng) {
                // Determine Color Logic: Has anyone logged in during the currently filtered shift/day?
                const hasLogin = currentShiftAttendance.some(log => log.facility === f.facilityName);
                const markerColor = hasLogin ? 'green' : 'red';
                const statusText = hasLogin ? '<span style="color:green">متاح (حضور نشط)</span>' : '<span style="color:red">غير متاح (لا يوجد حضور)</span>';

                const marker = L.marker([f.lat, f.lng], { icon: createCustomIcon(markerColor) })
                    .bindPopup(`<b>${f.facilityName}</b><br>${f.governorate}<br>${statusText}`);
                marker.facilityData = f;
                markersLayer.addLayer(marker);
            }
        });
    }

    window.searchOnMap = () => {
        const q = document.getElementById('map-search').value.toLowerCase();
        const resultBox = document.getElementById('map-search-results');
        resultBox.innerHTML = "";

        if (q.length < 1) {
            resultBox.style.display = "none";
            return;
        }

        const matches = allFacilities.filter(f => f.facilityName.toLowerCase().includes(q));

        if (matches.length > 0) {
            resultBox.style.display = "block";
            matches.forEach(f => {
                const div = document.createElement('div');
                div.className = "map-search-item";
                div.innerHTML = `<strong>${f.facilityName}</strong><br><small>${f.governorate}</small>`;
                div.onclick = () => {
                    map.setView([f.lat, f.lng], 15);
                    markersLayer.eachLayer(m => {
                        if(m.facilityData.facilityName === f.facilityName) m.openPopup();
                    });
                    resultBox.style.display = "none";
                };
                resultBox.appendChild(div);
            });
        } else {
            resultBox.style.display = "none";
        }
    };

    document.addEventListener('click', (e) => {
        if (e.target.id !== 'map-search') {
            const rb = document.getElementById('map-search-results');
            if(rb) rb.style.display = "none";
        }
    });

    // --- Global DB Operations ---

    window.deleteRecord = async (col, id) => {
        if(confirm("تحذير: هل أنت متأكد من حذف هذا السجل نهائيا؟")) {
            await deleteDoc(doc(db, col, id));
            refreshData();
        }
    };

    window.saveFacility = async () => {
        const name = document.getElementById('m-fac-name').value;
        const gov = document.getElementById('m-fac-gov').value;
        const lat = parseFloat(document.getElementById('m-fac-lat').value);
        const lng = parseFloat(document.getElementById('m-fac-lng').value);

        if(!name || !gov || isNaN(lat)) return alert("يرجى إكمال البيانات");

        const newId = "fac_" + Date.now();
        await setDoc(doc(db, "FacilitiesReference", newId), {
            facilityName: name,
            governorate: gov,
            lat: lat,
            lng: lng
        });
        closeModal();
        refreshData();
    };

    window.openEditUserModal = (id, data) => {
        document.getElementById('edit-u-id').value = id;
        document.getElementById('edit-u-name').value = data.fullName || '';
        document.getElementById('edit-u-ni').value = data.nationalID || '';
        document.getElementById('edit-u-pass').value = data.password || '';
        document.getElementById('edit-u-phone').value = data.phoneNumber || '';
        openModal('edit-user-modal');
    };

    window.updateUser = async () => {
        const id = document.getElementById('edit-u-id').value;
        await updateDoc(doc(db, "UsersRegistry", id), {
            fullName: document.getElementById('edit-u-name').value,
            nationalID: document.getElementById('edit-u-ni').value,
            password: document.getElementById('edit-u-pass').value,
            phoneNumber: document.getElementById('edit-u-phone').value
        });
        closeModal();
        refreshData();
    };

    window.openModal = (id) => {
        document.getElementById(id).style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
    };

    window.closeModal = () => {
        document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
        document.getElementById('overlay').style.display = 'none';
    };

    window.logoutAdmin = () => {
        sessionStorage.clear();
        window.location.href = "index.html";
    };

    // Generic Export Function for any table
    window.exportTableToExcel = (tableId, filenamePrefix) => {
        const table = document.getElementById(tableId);
        const wb = XLSX.utils.table_to_book(table, { sheet: "Sheet1" });
        const dateStamp = new Date().toISOString().split('T')[0];
        XLSX.writeFile(wb, `UHIA_${filenamePrefix}_${dateStamp}.xlsx`);
    };

</script>

</body>
</html>